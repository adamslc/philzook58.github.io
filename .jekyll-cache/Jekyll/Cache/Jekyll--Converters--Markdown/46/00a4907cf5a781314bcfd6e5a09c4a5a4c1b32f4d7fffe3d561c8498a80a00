I"Ô<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mi">30</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">9.8</span>
<span class="n">L</span> <span class="o">=</span> <span class="mf">0.4</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div></div>

<h1 id="lqr">LQR</h1>
<p>What is a LQR (Linear Quadratic Regulator? Itâ€™s a way to derive feedback system from the equations of motion.
Optimizing quadratic functions leads to a linear problem because the derivative of a quadratic term is a linear term.
So the LQR is a formulation of a control problem that uses a quadratic cost function and evolves under linear dynamics.
Basically the only math that mankind can rip to shreds is linear algebra (matrix shit). We can solve Matrix equations (and by that I mean we can get computers to solve) like nobodies business.
Hence it often behooves us to find a way to formulate any problem in engineering or physics in some kind of linear framework.
You can find more here:
    <a href="https://studywolf.wordpress.com/2016/02/03/the-iterative-linear-quadratic-regulator-method/">here</a></p>

<p>In the code we are following the conventions setup in <a href="https://katefvision.github.io/katefSlides/RECITATIONtrajectoryoptimization_katef.pdf">Some Stanford Notes</a></p>

<h3 id="defining-the-control-problem">Defining the Control Problem</h3>

<p>The formulation of a control problem is one in which we are trying a cost function C(x,u) that may be a sum over many time steps, where x is the state vector (may an often will include velocities. Anything we need to be able to predict the next state) and u is the control vector (some set of numbers we get to decide like voltage to a motor or something)
It just so happens that this combo is exactly solvable in terms of matrix operations.</p>

<p>Letâ€™s define $z=(x,u)$ as a vector that is made out of stacked state and action vectors (the direct sum of their spaces)
We want to find the solution to the problem $\min \sum_{t=0}^{N-1} (z_{t}^{T}C_tz_t + c_t^{T}z_t)$ such that $A_tz_{t}-z_{t+1}=0$
Now, one way of solving the problem would be to make just one big matrix with a dimensionality proportional to the number of time steps weâ€™re looking ahead, and maybe in fact that is smart since python is slow and putting everything into numpy might be both easier to program and faster. The constraint that the steps are connected by the dynamics can be implemented by adding in lagrange multipliers at every time step. This still maintains the quadratic nature of the minimization.
$\min \sum_{t=0}^{N-1} (z^{T}Cz + c^{T}z) +\sum_{t=0}^{N-2} \lambda_t^{T} (Az_{t}-z_{t+1})$
But letâ€™s take a different approach</p>

<h3 id="a-correspondence-to-reinforcement-learning">A Correspondence to Reinforcement Learning</h3>
<p>It is very interesting that there is a method to solve this problem that mirrors the methodology found in reinforcement learning.
If we had a way of evaluating the value of being in a state and we new which state and action takes us to, we should just take the action that puts us in the highest valued state.
That requires lookahead though. We need to know what state our actions take us to.
Hence there is a clever trick, the Q function. The Q function takes the current state and an action as parameters and outputs the expected return of that combo. With this, we donâ€™t need to lookahead using dynamics in order to figure out which is the best action, we can just search the different actions.</p>

<p>In the LQR, the V and Q functions are quadratic. This means they can be parametrized by a Matrix term and a vector term $Q_t(x,a)=z^{T} Q_t z + q_t^{T} z $</p>

<p>The solution starts as the end. At the end we already know the Q function. It is just the cost function, since there is no future cost to consider.
We can minimize with respect to the control u to get the value function V. The solution to this minimaztion is a way to write the control in terms of x, giving us a control matrix K. $u_t=Kx_t+k$ Substituting this expession into the Q expression removes the variable u, giving us the value function V. Then we can backup one step using the dynamics to get the previous Q function in terms of the current V function.</p>

<p>What is in particular good about this method is the sequence of K matrices we get, which are useful for a feedback system.</p>

<p>Now many systems are in fact not quadratic cost or linear dynamics. Nevertheless we can leverage our abilities to make an iterative solver for a linearization of the nonlinear stuff.
The mapping from the nonlinear problem is a touch confusing because the new variables xâ€™ and uâ€™ are the displacement from the current estimated trajectory, not the entire trajectory itself. First, this means the dynamics f vector is going to be zero since a zero displacement should evolve into a zero dispacelemtn. The c vector is also no longer the original. It is the gradient of cost function and in general will be a function of the actual path x,u.</p>

<p>It is important to note that the backward pass is done on the linearized dynamics of $\delta x = x-x_0 $. where $x_0$ is the actual path evaluted in the forward pass. Then we run the thing forward using the updated control sequence $u_0 + \delta u =u_0+ K_t x + k$</p>

<h3 id="dynamical-details">Dynamical Details</h3>
<p>I used split step integration (called Verlet or leapfrog) where I alternate updating the velocity and position. This scheme tends to be more stable and more energy conserving. When I updated them together at first using a straightforward euler step, the energy in the pendulum exploded. Ruh Roh. Unfortunately the way I did this makes every two steps correspond to a single time step.
There is almost certainly something to using ODEint rather than my own custom rolled integration routine. But then I canâ€™t use odeint for the backwards pass unless I used a finite difference to find the linearized dynamics. Which is actually a totally reaosnable approach btw. I made my bed.</p>

<p>Weâ€™re using cartpole as an example since the whole reason this code was written was to control a cartpole. The idea is you have a cart with a hinged pole that you need to balance by pushing the cart back and forth.</p>

<p>The equations of motion for a cartpole are
$\frac{d^2\theta}{dt^2}=\frac{3}{2L}(a \sin(\theta)-g\cos(\theta))$
I got this out of a Lagrangian. Donâ€™t worry about it. The point is by accelerating the cart an amount a, you can apply a torque to the pole. The $\sin$ factor means you get no torque if the pole is horizontal and maximum torque if the pole is vertical. The standing upright position is the place where g has the least effect and a has the most effect, which is nice.
The linearization around this path is given by
$\frac{d^2\delta\theta}{dt^2}=\frac{3}{2L}(a \delta\theta\cos(\theta)+\delta a \sin(\theta) +g\delta\theta\sin(\theta))$
It is these equations that generate the F needed by LQR</p>

<p>To make C mostly have comparable units we add factors corresponding to the important physical scales. $\sqrt(L/g)$ is the time it takes for a small perturbation from equilibrium to roughly double. $g$ is the gravitational acceleration that any cart acceleration is going to be compared to.</p>

<p>Without further ado, big hunks of monolithic badly written code!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">F</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="c1">#Linearized dynamics matrix
</span>    <span class="k">if</span> <span class="n">t</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span> <span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">L</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dt</span><span class="p">]])</span>

<span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="c1">#One time step. One Even steps update theta on odd steps update derivative of theta
</span>    <span class="k">if</span> <span class="n">t</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">theta1</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span> 
        <span class="n">dtheta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta1</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    
        <span class="n">dtheta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">-</span> <span class="n">g</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">))</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">theta1</span><span class="p">,</span><span class="n">dtheta</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">xu</span><span class="p">):</span> 
    <span class="c1">#Offset of dynamics is always zero in iLQR. The system always will follow it's original trajectory if
</span>    <span class="c1"># \delta x is zero. 
</span>    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">C</span><span class="p">():</span> <span class="c1">#Cost Matrix
</span>    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">g</span><span class="p">),</span><span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.01</span> <span class="o">/</span> <span class="n">g</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">a</span><span class="p">):</span> <span class="c1">#Cost vector. It is the first derivative of the cost function evaluated at the current trajectory
</span>    <span class="k">return</span> <span class="n">C</span><span class="p">()</span> <span class="o">@</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">])</span>

<span class="c1"># A set of routines for packing and unpacking the state and control blocks of matrices and vectors.
</span><span class="k">def</span> <span class="nf">xxBlock</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">xuBlock</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">].</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">uxBlock</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">].</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">uuBlock</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">].</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">Block</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">xu</span><span class="p">,</span><span class="n">ux</span><span class="p">,</span><span class="n">uu</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">block</span><span class="p">([[</span><span class="n">xx</span><span class="p">,</span><span class="n">xu</span><span class="p">],[</span><span class="n">ux</span><span class="p">,</span><span class="n">uu</span><span class="p">]])</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">uu</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ux</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">xu</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span>
    <span class="k">return</span> <span class="n">R</span>
<span class="k">def</span> <span class="nf">xBlock</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">uBlock</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">Stack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">u</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">v</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
    <span class="k">return</span> <span class="n">v</span> 
    
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#N is the number of steps to lookahead
# ass holds the accelerations. as is a python keyword, that's why I made it ass. Also it is funny.
#thetas hold time 0...N
#ass hold time 0...N
</span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">theta0</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">ass0</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ass</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thetas</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta0</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">theta0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ass0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">@</span><span class="p">(</span><span class="n">theta</span><span class="o">-</span><span class="n">thetas0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">thetas</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">ass</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ass0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">@</span><span class="p">(</span><span class="n">theta</span><span class="o">-</span><span class="n">thetas0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ass</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span>

<span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">ass0</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="c1">#This is a transcription of the Stanford slides basically. See link way above.
</span>    <span class="n">Q</span> <span class="o">=</span>  <span class="n">C</span><span class="p">()</span> <span class="c1">#For the final step t=N, The Q matrix is just the Cost Matrix
</span>    <span class="n">q</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">thetas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ass0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#likewise
</span>    <span class="n">K</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">inv</span><span class="p">(</span><span class="n">uuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span> <span class="o">@</span> <span class="n">uxBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">inv</span><span class="p">(</span><span class="n">uuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span> <span class="o">@</span> <span class="n">uBlock</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">xxBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">+</span> <span class="n">xuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">@</span> <span class="n">K</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">uxBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">uuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">@</span> <span class="n">K</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">xBlock</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">xuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">@</span> <span class="n">k</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">uBlock</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">uuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">@</span> <span class="n">k</span>
    <span class="n">Ks</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#We'll collect up and store the control matrices (matrices that give good linear feedback), u=Kx+k
</span>    <span class="n">ks</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span> <span class="c1"># counts time N-1 down to 0
</span>        <span class="n">Ft</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">thetas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ass0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="c1">#Dynamics matrix x_{t+1} = F @ (x_t,u_t) + f
</span>        <span class="n">ft</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#step(thetas[i], ass0[i])
</span>        <span class="c1">#print(ft)
</span>        <span class="n">Q</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span> <span class="o">+</span> <span class="n">Ft</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">V</span> <span class="o">@</span> <span class="n">Ft</span> <span class="c1"># comes from C + x_t+1 @ V @x_t+1, 
</span>        <span class="n">q</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">thetas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ass0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">Ft</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">V</span> <span class="o">@</span> <span class="n">ft</span> <span class="o">+</span> <span class="n">Ft</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">v</span>
        <span class="c1">#print(Q)
</span>        <span class="c1">#print(uuBlock(Q))
</span>        <span class="n">K</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">inv</span><span class="p">(</span><span class="n">uuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span> <span class="o">@</span> <span class="n">uxBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="c1">#minimizing over u.
</span>        <span class="n">k</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">inv</span><span class="p">(</span><span class="n">uuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span> <span class="o">@</span> <span class="n">uBlock</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">xxBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">+</span> <span class="n">xuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">@</span> <span class="n">K</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">uxBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">uuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">@</span> <span class="n">K</span> <span class="c1">#substituting u = Kx+k into Q
</span>        <span class="n">v</span> <span class="o">=</span> <span class="n">xBlock</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">xuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">@</span> <span class="n">k</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">uBlock</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">uuBlock</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">@</span> <span class="n">k</span>
        <span class="n">Ks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="n">ks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">Ks</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">ks</span><span class="p">))</span>

<span class="c1">#Takes an initial value of theta, iterations of backward forward passes and perhaps an initialization of control.
</span><span class="k">def</span> <span class="nf">iLQR</span><span class="p">(</span><span class="n">theta0</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">Ks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ks</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Ks</span><span class="p">:</span>
        <span class="n">Ks</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ks</span><span class="p">:</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ass</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">thetas</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
        <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span> <span class="o">=</span> <span class="n">forward</span><span class="p">(</span><span class="n">theta0</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ass</span><span class="p">)</span>
        
        <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span> <span class="o">=</span> <span class="n">backward</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span>
    

        
</code></pre></div></div>

<p>If we set the pendulum at the (unstable) equilibrium position, it should not require much intervention. Sanity check.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="o">=</span> <span class="n">iLQR</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]),</span> <span class="n">iters</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="c1">#print(thetas)
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[&lt;matplotlib.lines.Line2D at 0x10d1329b0&gt;]
</code></pre></div></div>

<p><img src="/pynb/LQR2-Copy1_files/LQR2-Copy1_5_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Deomnstrating the convergence properties in terms of iLQR iterations
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="o">=</span> <span class="n">iLQR</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]),</span> <span class="n">iters</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#print(Ks)
</span></code></pre></div></div>

<p><img src="/pynb/LQR2-Copy1_files/LQR2-Copy1_6_0.png" alt="png" /></p>

<p>Uncontrolled evolution</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span><span class="o">=</span><span class="mi">40</span>
<span class="n">theta0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">])</span>
<span class="n">Ks</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ass</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">thetas</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span> <span class="o">=</span> <span class="n">forward</span><span class="p">(</span><span class="n">theta0</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[&lt;matplotlib.lines.Line2D at 0x10cd3d470&gt;]
</code></pre></div></div>

<p><img src="/pynb/LQR2-Copy1_files/LQR2-Copy1_8_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Demonstrating the convergence properties in terms of iLQR iterations
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="o">=</span> <span class="n">iLQR</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]),</span> <span class="n">iters</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<p><img src="/pynb/LQR2-Copy1_files/LQR2-Copy1_9_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Deomnstrating the convergence properties in terms of lookahead
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="o">=</span> <span class="n">iLQR</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]),</span> <span class="n">iters</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#print(Ks)
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/lib/python3.6/site-packages/ipykernel_launcher.py:39: RuntimeWarning: invalid value encountered in add
/usr/local/lib/python3.6/site-packages/ipykernel_launcher.py:40: RuntimeWarning: invalid value encountered in add
</code></pre></div></div>

<p><img src="/pynb/LQR2-Copy1_files/LQR2-Copy1_10_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Deomnstrating the convergence properties in terms of lookahead
</span><span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="o">=</span> <span class="n">iLQR</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]),</span> <span class="n">iters</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span> <span class="o">=</span> <span class="n">iLQR</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]),</span> <span class="n">iters</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ks</span><span class="o">=</span><span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="o">=</span><span class="n">ks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">Ks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#print(Ks)
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/lib/python3.6/site-packages/ipykernel_launcher.py:39: RuntimeWarning: invalid value encountered in add
</code></pre></div></div>

<p><img src="/pynb/LQR2-Copy1_files/LQR2-Copy1_11_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Deomnstrating the convergence properties in terms of lookahead
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="o">=</span> <span class="n">iLQR</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">]),</span> <span class="n">iters</span><span class="o">=</span><span class="mi">105</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>

</code></pre></div></div>

<p><img src="/pynb/LQR2-Copy1_files/LQR2-Copy1_12_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Deomnstrating the convergence properties in terms perturbation from stable position
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">thetas</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">Ks</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="o">=</span> <span class="n">iLQR</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">15</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]),</span> <span class="n">iters</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="c1">#print(Ks)
#print(ass)
</span></code></pre></div></div>

<p><img src="/pynb/LQR2-Copy1_files/LQR2-Copy1_13_0.png" alt="png" /></p>

<p>Thatâ€™s kind of curious behavior. There is an area where it doesnâ€™t know what to do really but then it comes back. It kind of makes sense.</p>
:ET